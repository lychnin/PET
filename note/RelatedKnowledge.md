# Related Knowledge以及代码逐行解析
[Toc]
## 如何可视化查看nii文件
可以下载[ITK-SNAP 4.0](http://www.itksnap.org/pmwiki/pmwiki.php?n=Downloads.SNAP4)

体素是**体积元素**（Volume Pixel）的简称，是数字数据于**三维空间**分割上的最小单位，类似于二维空间的像素。体素用于三维成像、科学数据与医学影像等领域。体素可以通过立体渲染或者提取给定阈值轮廓的多边形等值面表现出来。

nii的三维数组是一个包含了图像体素值的数据结构，它的每个元素代表了一个体素的灰度值或者信号强度。nii的三维数组的形状是（z,y,x），其中z是沿着图像的垂直方向，y是沿着图像的前后方向，x是沿着图像的左右方向。

每个体素的值代表了该体素在物理空间中的像素值，也就是该体素的灰度或颜色。(128, 128, 47, 1)表示图像数据的维度，也就是图像有多少个体素。第一个数字128表示图像在x轴方向上有128个体素，第二个数字128表示图像在y轴方向上有128个体素，第三个数字47表示图像在z轴方向上有47个体素，第四个数字1表示每个体素只有一个值，也就是单通道。如果第四个数字是3，就表示每个体素有三个值，也就是RGB三通道。

头文件信息是nii文件中用于描述图像属性的部分，它包括了以下一些参数：

- **维度**：图像的维数和每个维度的大小，比如（256,256,256）表示一个三维图像，每个维度有256个体素。
- **方向**：图像的空间方向，比如左右、前后、上下等，用于确定图像的坐标系。
- **分辨率**：图像每个体素的物理尺寸，比如（1mm,1mm,1mm）表示每个体素占据一个立方毫米的空间。
- **仿射变换**：图像的空间变换矩阵，用于将体素索引（i,j,k）转换为空间位置（x,y,z）。
- **数据类型**：图像每个体素的数据类型，比如uint8、float32等，用于确定图像的灰度范围和精度。
- **其他信息**：图像的描述、单位、时间轴、意向代码等，用于提供更多的图像元数据。

头文件信息中有很多参数，介绍一些常见的：

- sizeof_hdr: 头文件的大小，一般是348字节²
- dim: 数据的维度，一般有7个维度，分别是空间维度x,y,z，时间维度t，和其他可供用户使用的维度²
- datatype: 数据的类型，例如float32表示浮点数，bitpix表示每个数据占用的位数²
- pixdim: 每个维度的物理尺寸，例如x,y,z方向上每个体素的长度³
- vox_offset: 数据开始的偏移量，一般是0或者352⁴
- qform_code和sform_code: 表示空间坐标系的类型，例如scanner表示扫描仪坐标系²
- affine: 一个4x4的矩阵，表示空间坐标系和体素索引之间的变换关系¹


nii文件的仿射矩阵是一个4x4的矩阵，它的作用是将图像的**体素坐标**（即矩阵中的行、列、层）转换为**物理坐标**（即实际空间中的x、y、z）。这样可以方便地对不同的图像进行对齐、配准、变换等操作。仿射矩阵的形式如下：


$$\begin{bmatrix}x \\y \\z \\1\end{bmatrix}=\begin{bmatrix}a_{11} & a_{12} & a_{13} & a_{14} \\a_{21} & a_{22} & a_{23} & a_{24} \\a_{31} & a_{32} & a_{33} & a_{34} \\0 & 0 & 0 & 1\end{bmatrix}\begin{bmatrix}i \\j \\k \\1\end{bmatrix}$$

其中，$x,y,z$是物理坐标，$i,j,k$是体素坐标，$a_{ij}$是仿射矩阵的元素。

最后一行是为了保证变换前后都是齐次坐标。

![Alt text](image-1.png)
